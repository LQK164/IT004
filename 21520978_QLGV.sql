create database QLGV
use QLGV
-- BANG HOC VIEN
create table HOCVIEN(
	MAHV char(5) primary key,
	HO varchar(40),
	TEN varchar(10),
	NGSINH smalldatetime,
	GIOITINH varchar(3),
	NOISINH varchar(40),
	MALOP char(3),
)
--Cau 1 phan III
ALTER TABLE HOCVIEN ADD GHICHU VARCHAR(60)
ALTER TABLE HOCVIEN ADD DIEMTB NUMERIC(4, 2)
ALTER TABLE HOCVIEN ADD XEPLOAI VARCHAR(10)
ALTER TABLE HOCVIEN
	ADD CONSTRAINT FK_ML FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)
--Cau 11
ALTER TABLE HOCVIEN
	ADD CONSTRAINT THV CHECK (GETDATE() - NGSINH >= 18)
--cau 3
ALTER TABLE HOCVIEN
	ADD CONSTRAINT GT CHECK (GIOITINH in ('nam', 'nu'))
--cau 2
ALTER TABLE HOCVIEN
	ADD CONSTRAINT CK_MAHV CHECK ((LEFT(MAHV, 3) LIKE MALOP) AND RIGHT(CAST(MAHV AS INT), 2) >= 1 AND RIGHT(CAST(MAHV AS INT), 2) <= 12)
-- BANG LOP
create table LOP(
	MALOP char(3) primary key,
	TENLOP varchar(40),
	TRGLOP char(5),
	SISO tinyint,
	MAGVCN char(4),
)
ALTER TABLE LOP
	ADD CONSTRAINT LT CHECK (LEFT(TRGLOP, 3) = MALOP)
-- BANG KHOA
create table KHOA(
	MAKHOA varchar(4) primary key,
	TENKHOA varchar(40),
	NGTLAP smalldatetime,
	TRGKHOA char(4),
)
-- BANG MON HOC
create table MONHOC(
	MAMH varchar(10) primary key,
	TENMH varchar(40),
	TCLT tinyint,
	TCTH tinyint,
	MAKHOA varchar(4),
)
ALTER TABLE MONHOC
	ADD CONSTRAINT FK_MK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
--Cau 14
ALTER TABLE MONHOC
	ADD CONSTRAINT STC CHECK (ABS(TCLT - TCTH) <= 3)
create table DIEUKIEN(
	MAMH varchar(10),
	MAMH_TRUOC varchar(10),
	constraint PK_DK primary key(MAMH, MAMH_TRUOC),
)
ALTER TABLE DIEUKIEN
	ADD CONSTRAINT FK_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)
-- BANG GIAO VIEN
create table GIAOVIEN(
	MAGV char(4) primary key,
	HOTEN varchar(40),
	HOCVI varchar(10),
	HOCHAM varchar(10),
	GIOITINH varchar(3),
	NGSINH smalldatetime,
	NGVL smalldatetime,
	HESO numeric(4,2),
	MUCLUONG money,
	MAKHOA varchar(4),
)
--cau 8
ALTER TABLE GIAOVIEN
	ADD CONSTRAINT HV CHECK (HOCVI in ('CN', 'KS', 'ThS', 'TS', 'PGS'))
ALTER TABLE GIAOVIEN
	ADD CONSTRAINT FK_MK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
--Cau 13
ALTER TABLE GIAOVIEN
	ADD CONSTRAINT TGV CHECK (GETDATE() - NGSINH >= 22)
create table GIANGDAY(
	MALOP char(3),
	MAMH varchar(10),
	MAGV char(4),
	HOCKY tinyint,
	NAM smallint,
	TUNGAY smalldatetime,
	DENNGAY smalldatetime,
	constraint PK_GIANGDAY primary key(MALOP, MAMH)
)
--cau 7
ALTER TABLE GIANGDAY
	ADD CONSTRAINT HK CHECK (HOCKY <= 3 and HOCKY >= 1)
ALTER TABLE GIANGDAY
	ADD CONSTRAINT FK_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)
ALTER TABLE GIANGDAY
	ADD CONSTRAINT FK_ML FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)
ALTER TABLE GIANGDAY
	ADD CONSTRAINT FK_MGV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)
--Cau 12
ALTER TABLE GIANGDAY
	ADD CONSTRAINT BDKT CHECK (TUNGAY < DENNGAY)
-- BANG KET QUA THI
create table KETQUATHI(
	MAHV char(5),
	MAMH varchar(10),
	LANTHI tinyint,
	NGTHI smalldatetime,
	DIEM numeric(4,2),
	KETQUA varchar(10),
	constraint PK_GIANGDAY primary key(MAHV, MAMH, LANTHI)
)
ALTER TABLE KETQUATHI
	ADD CONSTRAINT FK_MHV FOREIGN KEY (MAHV) REFERENCES HOCVIEN(MAHV)
ALTER TABLE KETQUATHI
	ADD CONSTRAINT FK_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)
--cau 6
ALTER TABLE KETQUATHI
	ADD CONSTRAINT LT CHECK (LANTHI <=3)
--cau 4
ALTER TABLE KETQUATHI
	ADD CONSTRAINT KQT CHECK(DIEM <=10 AND DIEM >= 0)
--cau 5
ALTER TABLE KETQUATHI
	ADD CHECK ((KQT = 'DAT' and DIEM between 5 and 10) OR (KQT = ' KHONG DAT' and DIEM >=0 and DIEM < 5))
SET DATEFORMAT DMY
INSERT INTO HOCVIEN VALUES('K1101','Nguyen Van','A','27/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1102','Tran Ngoc','Han','14/3/1986','Nu','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES('K1103','Ha Duy','Lap','18/4/1986','Nam','Nghe An','K11')
INSERT INTO HOCVIEN VALUES('K1104','Tran Ngoc','Linh','30/3/1986','Nu','Tay Ninh','K11')
INSERT INTO HOCVIEN VALUES('K1105','Tran Minh','Long','27/2/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1106','Le Nhat','Minh','24/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES('K1107','Nguyen Nhu','Nhut','27/1/1986','Nam','Ha Noi','K11')
INSERT INTO HOCVIEN VALUES('K1108','Nguyen Manh','Tam','27/2/1986','Nam','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES('K1109','Phan Thi Thanh','Tam','27/1/1986','Nu','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES('K1110','Le Hoai','Thuong','5/2/1986','Nu','Can Tho','K11')
INSERT INTO HOCVIEN VALUES('K1111','Le Ha','Vinh','25/12/1986','Nam','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES('K1201','Nguyen Van','B','11/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1202','Nguyen Thi Kim','Duyen','18/1/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1203','Tran Thi Kim','Duyen','17/9/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1204','Truong My','Hanh','19/5/1986','Nu','Dong Nai','K12')
INSERT INTO HOCVIEN VALUES('K1205','Nguyen Thanh','Nam','17/4/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES('K1206','Nguyen Thi Truc','Thanh','4/3/1986','Nu','Kien Giang','K12')
alter table hocvien nocheck constraint FK_ML
alter table hocvien check constraint FK_ML

INSERT INTO LOP VALUES('K11','Lop 1 khoa 1','K1108',11,'GV07')
INSERT INTO LOP VALUES('K12','Lop 2 khoa 1','K1205',12,'GV09')
INSERT INTO LOP VALUES('K13','Lop 3 khoa 1','K1305',12,'GV14')

-- NHAP DU LIEU KHOA --
INSERT INTO KHOA VALUES('KHMT','Khoa hoc may tinh','7/6/2005','GV01')
INSERT INTO KHOA VALUES('HTTT','He thong thong tin','7/6/2005','GV02')
INSERT INTO KHOA VALUES('CNPM','Cong nghe phan mem','7/6/2005','GV04')
INSERT INTO KHOA VALUES('MTT','Mang va truyen thong','20/10/2005','GV03')
INSERT INTO KHOA VALUES('KTMT','Ky thuat may tinh','20/12/2005',Null)

-- NHAP DU LIEU GIAOVIEN --
INSERT INTO GIAOVIEN VALUES('GV01','Ho Thanh Son','PTS','GS','Nam','2/5/1950','11/1/2004',5,2250000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV02','Tran Tam Thanh','TS','PGS','Nam','17/12/1965','20/4/2004',4.5,2025000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV03','Do Nghiem Phung','TS','GS','Nu','1/8/1950','23/9/2004',4,1800000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV04','Tran Nam Son','TS','PGS','Nam','22/2/1961','12/1/2005',4.5,2025000,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV05','Mai Thanh Danh','ThS','GV','Nam','12/3/1958','12/1/2005',3,1350000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV06','Tran Doan Hung','TS','GV','Nam','11/3/1953','12/1/2005',4.5,2025000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV07','Nguyen Minh Tien','ThS','GV','Nam','23/11/1971','1/3/2005',4,1800000,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV08','Le Thi Tran','KS',Null,'Nu','26/3/1974','1/3/2005',1.69,760500,'KHMT')
INSERT INTO GIAOVIEN VALUES('GV09','Nguyen To Lan','ThS','GV','Nu','31/12/1966','1/3/2005',4,1800000,'HTTT')
INSERT INTO GIAOVIEN VALUES('GV10','Le Tran Anh Loan','KS',Null,'Nu','17/7/1972','1/3/2005',1.86,837000,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV11','Ho Thanh Tung','CN','GV','Nam','12/1/1980','15/5/2005',2.67,1201500,'MTT')
INSERT INTO GIAOVIEN VALUES('GV12','Tran Van Anh','CN',Null,'Nu','29/3/1981','15/5/2005',1.69,760500,'CNPM')
INSERT INTO GIAOVIEN VALUES('GV13','Nguyen Linh Dan','CN',Null,'Nu','23/5/1980','15/5/2005',1.69,760500,'KTMT')
INSERT INTO GIAOVIEN VALUES('GV14','Truong Minh Chau','ThS','GV','Nu','30/11/1976','15/5/2005',3,1350000,'MTT')
INSERT INTO GIAOVIEN VALUES('GV15','Le Ha Thanh','ThS','GV','Nam','4/5/1978','15/5/2005',3,1350000,'KHMT')

-- NHAP DU LIEU MONHOC --
INSERT INTO MONHOC VALUES('THDC','Tin hoc dai cuong',4,1,'KHMT')
INSERT INTO MONHOC VALUES('CTRR','Cau truc roi rac',5,0,'KHMT')
INSERT INTO MONHOC VALUES('CSDL','Co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('CTDLGT','Cau truc du lieu va giai thuat',3,1,'KHMT')
INSERT INTO MONHOC VALUES('PTTKTT','Phan tich thiet ke thuat toan',3,0,'KHMT')
INSERT INTO MONHOC VALUES('DHMT','Do hoa may tinh',3,1,'KHMT')
INSERT INTO MONHOC VALUES('KTMT','Kien truc may tinh',3,0,'KTMT')
INSERT INTO MONHOC VALUES('TKCSDL','Thiet ke co so du lieu',3,1,'HTTT')
INSERT INTO MONHOC VALUES('PTTKHTTT','Phan tich thiet ke he thong thong tin',4,1,'HTTT')
INSERT INTO MONHOC VALUES('HDH','He dieu hanh',4,0,'KTMT')
INSERT INTO MONHOC VALUES('NMCNPM','Nhap mon cong nghe phan mem',3,0,'CNPM')
INSERT INTO MONHOC VALUES('LTCFW','Lap trinh C for win',3,1,'CNPM')
INSERT INTO MONHOC VALUES('LTHDT','Lap trinh huong doi tuong',3,1,'CNPM')

-- NHAP DU LIEU GIANGDAY --
INSERT INTO GIANGDAY VALUES ('K11','THDC','GV07',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K12','THDC','GV06',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K13','THDC','GV15',1,2006,'2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTRR','GV02',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTRR','GV02',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTRR','GV08',1,2006,'9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K11','CSDL','GV05',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K12','CSDL','GV09',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTDLGT','GV15',2,2006,'1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K13','CSDL','GV05',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K13','DHMT','GV07',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTDLGT','GV15',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTDLGT','GV15',3,2006,'1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','HDH','GV04',1,2007,'2/1/2007','18/2/2007')
INSERT INTO GIANGDAY VALUES ('K12','HDH','GV04',1,2007,'2/1/2007','20/3/2007')
INSERT INTO GIANGDAY VALUES ('K11','DHMT','GV07',1,2007,'18/2/2007','20/3/2007')

-- NHAP DU LIEU DIEUKIEN --
INSERT INTO DIEUKIEN VALUES ('CSDL','CTRR')
INSERT INTO DIEUKIEN VALUES ('CSDL','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('CTDLGT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('DHMT','THDC')
INSERT INTO DIEUKIEN VALUES ('LTHDT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKHTTT','CSDL')

-- NHAP DU LIEU KETQUATHI --
INSERT INTO KETQUATHI VALUES ('K1101','CSDL',1,'20/7/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTDLGT',1,'28/12/2006',9,'Dat')
INSERT INTO KETQUATHI VALUES ('K1101','THDC',1,'20/5/2006',9,'Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTRR',1,'13/5/2006',9.5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL',1,'20/7/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL',2,'27/7/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL',3,'10/8/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT',1,'28/12/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT',2,'5/1/2007',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT',3,'15/1/2007',6,'Dat')
INSERT INTO KETQUATHI VALUES ('K1102','THDC',1,'20/5/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTRR',1,'13/5/2006',7,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL',1,'20/7/2006',3.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL',2,'27/7/2006',8.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTDLGT',1,'28/12/2006',7,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','THDC',1,'20/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTRR',1,'13/5/2006',6.5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CSDL',1,'20/7/2006',3.75,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTDLGT',1,'28/12/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','THDC',1,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR',1,'13/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR',2,'20/5/2006',3.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR',3,'30/6/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CSDL',1,'20/7/2006',6,'Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTDLGT',1,'28/12/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1201','THDC',1,'20/5/2006',8.5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTRR',1,'13/5/2006',9,'Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CSDL',1,'20/7/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT',1,'28/12/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT',2,'5/1/2007',5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC',1,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC',2,'27/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR',1,'13/5/2006',3,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR',2,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR',3,'30/6/2006',6.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CSDL',1,'20/7/2006',9.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTDLGT',1,'28/12/2006',9.5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','THDC',1,'20/5/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTRR',1,'13/5/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CSDL',1,'20/7/2006',8.5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTDLGT',1,'28/12/2006',6.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1204','THDC',1,'20/5/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTRR',1,'13/5/2006',6,'Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CSDL',1,'20/12/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTDLGT',1,'25/7/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES ('K1301','THDC',1,'20/5/2006',7.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTRR',1,'13/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CSDL',1,'20/12/2006',6.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTDLGT',1,'25/7/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','THDC',1,'20/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTRR',1,'13/5/2006',8.5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CSDL',1,'20/12/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT',1,'25/7/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT',2,'7/8/2006',4,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT',3,'15/8/2006',4.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','THDC',1,'20/5/2006',4.5,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR',1,'13/5/2006',3.25,'Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR',2,'20/5/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CSDL',1,'20/12/2006',7.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTDLGT',1,'25/7/2006',9.75,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','THDC',1,'20/5/2006',5.5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTRR',1,'13/5/2006',5,'Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CSDL',1,'20/12/2006',9.25,'Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CTDLGT',1,'25/7/2006',10,'Dat')
INSERT INTO KETQUATHI VALUES ('K1305','THDC',1,'20/5/2006',8,'Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CTRR',1,'13/5/2006',10,'Dat')
--Cau 1 phan II
UPDATE GIAOVIEN 
SET HESO += HESO * 0.02 
WHERE MAGV IN (SELECT TRGKHOA FROM KHOA)
--Cau 2 phan II
UPDATE HV SET DIEMTB = DTB_HOCVIEN.DTB
FROM HOCVIEN HV LEFT JOIN (
	SELECT MAHV, AVG(DIEM) AS DTB 
	FROM KETQUATHI A
	WHERE NOT EXISTS (
		SELECT 1 
		FROM KETQUATHI B 
		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
	) 
	GROUP BY MAHV
) DTB_HOCVIEN
ON HV.MAHV = DTB_HOCVIEN.MAHV
--Cau 3 phan II
UPDATE HOCVIEN SET GHICHU = 'Cam thi'
WHERE MAHV IN (
	SELECT MAHV 
	FROM KETQUATHI 
	WHERE LANTHI = 3 AND DIEM < 5
)
--Cau 4 phan III
UPDATE HOCVIEN SET XEPLOAI = CASE 
	WHEN DIEMTB >= 9 THEN 'XS'
	WHEN DIEMTB >= 8 THEN 'G'
	WHEN DIEMTB >= 6.5 THEN 'K'
	WHEN DIEMTB >= 5 THEN 'TB'
	ELSE 'Y' END
--Cau 1 phan III
SELECT HV.MAHV, HO + ' ' + TEN AS HOTEN, NGSINH, HV.MALOP 
	FROM HOCVIEN HV INNER JOIN LOP 
	ON HV.MAHV = LOP.TRGLOP
--Cau 2 phan III
SELECT KQ.MAHV, HO + ' ' + TEN AS HOTEN, LANTHI, DIEM 
	FROM KETQUATHI KQ INNER JOIN HOCVIEN HV 
	ON KQ.MAHV = HV.MAHV
	WHERE LEFT(KQ.MAHV, 3) = 'K12' AND MAMH = 'CTRR'
	ORDER BY TEN, HO
--Cau 3 phan III
SELECT KQ.MAHV, HO + ' ' + TEN AS HOTEN, MAMH
	FROM KETQUATHI KQ INNER JOIN HOCVIEN HV 
	ON KQ.MAHV = HV.MAHV
	GROUP BY KQ.MAHV, HO, TEN, MAMH, KETQUA
	HAVING MAX(LANTHI) = 1 AND KETQUA ='DAT'
	ORDER BY KQ.MAHV
--Cau 4 phan III
SELECT KQ.MAHV, HO + ' ' + TEN AS HOTEN
	FROM KETQUATHI KQ INNER JOIN HOCVIEN HV 
	ON KQ.MAHV = HV.MAHV
	WHERE LEFT(KQ.MAHV, 3) = 'K11' AND MAMH = 'CTRR' AND LANTHI = 1 AND KETQUA = 'Khong Dat'
--Cau 5 phan III
SELECT A.MAHV, HOTEN FROM (
	SELECT KQ.MAHV, HO + ' ' + TEN AS HOTEN, LANTHI
	FROM KETQUATHI KQ INNER JOIN HOCVIEN HV 
	ON KQ.MAHV = HV.MAHV
	WHERE LEFT(KQ.MAHV, 3) = 'K11' AND MAMH = 'CTRR' AND KETQUA = 'Khong Dat'
) A 
INNER JOIN (
	SELECT MAHV, MAX(LANTHI) LANTHIMAX FROM KETQUATHI 
	WHERE LEFT(MAHV, 3) = 'K11' AND MAMH = 'CTRR'
	GROUP BY MAHV, MAMH 
) B 
ON A.MAHV = B.MAHV
WHERE LANTHI = LANTHIMAX
--Cau 6 phan III
SELECT MAMH, TENMH FROM MONHOC
WHERE MAMH IN (
	SELECT DISTINCT MAMH 
	FROM GIANGDAY GD INNER JOIN GIAOVIEN GV 
	ON GD.MAGV = GV.MAGV 
	WHERE HOTEN = 'Tran Tam Thanh' AND HOCKY = 1 AND NAM = 2006
)
--Cau 7 phan III
SELECT MAMH, TENMH FROM MONHOC
WHERE MAMH IN (
	SELECT DISTINCT MAMH FROM GIANGDAY WHERE MAGV IN (
		SELECT MAGVCN FROM LOP WHERE MALOP = 'K11'
	) AND HOCKY = 1 AND NAM = 2006)
--Cau 8 phan III
SELECT HO + ' ' + TEN AS HOTEN FROM HOCVIEN
	WHERE MAHV IN (
		SELECT TRGLOP FROM LOP 
		WHERE MALOP IN (
			SELECT DISTINCT MALOP FROM GIANGDAY 
			WHERE MAGV IN (
				SELECT MAGV FROM GIAOVIEN WHERE HOTEN = 'Nguyen To Lan'
			)AND MAMH IN (
				SELECT MAMH FROM MONHOC WHERE TENMH = 'Co So Du Lieu'
			)
		)
	)
--Cau 9 phan III
SELECT MAMH, TENMH FROM MONHOC
	WHERE MAMH IN (
		SELECT MAMH_TRUOC FROM DIEUKIEN WHERE MAMH IN (
			SELECT MAMH FROM MONHOC WHERE TENMH = 'Co So Du Lieu'
		)
	)
--Cau 10 phan III
SELECT MAMH, TENMH FROM MONHOC
	WHERE MAMH IN (
		SELECT MAMH FROM DIEUKIEN WHERE MAMH_TRUOC IN (
			SELECT MAMH FROM MONHOC WHERE TENMH = 'Cau Truc Roi Rac'
			)
		)
--Cau 11 phan III
SELECT HOTEN FROM GIAOVIEN 
	WHERE MAGV IN (
		SELECT MAGV FROM GIANGDAY 
		WHERE MAMH = 'CTRR' AND MALOP IN ('K11', 'K12') AND HOCKY = 1 AND NAM = 2006
		GROUP BY MAGV 
		HAVING COUNT(DISTINCT MALOP) = 2
	)
--Cau 12 phan III
SELECT MAHV, HO + ' ' + TEN AS HOTEN FROM HOCVIEN 
	WHERE MAHV IN (
		SELECT MAHV FROM KETQUATHI A
		WHERE NOT EXISTS (
			SELECT 1 FROM KETQUATHI B 
			WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
		) AND MAMH = 'CSDL' AND LANTHI = 1 AND KETQUA = 'Khong Dat'
	)
--Cau 13 phan III
SELECT MAGV, HOTEN FROM GIAOVIEN 
	WHERE MAGV NOT IN (
		SELECT DISTINCT MAGV FROM GIANGDAY
	)
--Cau 14 phan III
SELECT MAGV, HOTEN FROM GIAOVIEN 
	WHERE MAGV NOT IN (
		SELECT GD.MAGV
		FROM GIANGDAY GD INNER JOIN GIAOVIEN GV 
		ON GD.MAGV = GV.MAGV INNER JOIN MONHOC MH
		ON GD.MAMH = MH.MAMH
		WHERE GV.MAKHOA = MH.MAKHOA
	)
--Cau 15 phan III
SELECT HO + ' ' + TEN AS HOTEN FROM HOCVIEN
WHERE MAHV IN (
	SELECT MAHV FROM KETQUATHI A
	WHERE LEFT(MAHV, 3) = 'K11' AND ((
		NOT EXISTS (
			SELECT 1 FROM KETQUATHI B 
			WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
		)  AND LANTHI = 3 AND KETQUA = 'Khong Dat'
	) OR MAMH = 'CTRR' AND LANTHI = 2 AND DIEM = 5)
)
--Cau 16 phan III
SELECT HOTEN FROM GIAOVIEN 
WHERE MAGV IN (
	SELECT MAGV FROM GIANGDAY 
	WHERE MAMH = 'CTRR'
	GROUP BY MAGV, HOCKY, NAM 
	HAVING COUNT(MALOP) >= 2
)
--Cau 17 phan III
SELECT HV.MAHV, HO + ' ' + TEN AS HOTEN, DIEM 
FROM HOCVIEN HV INNER JOIN (
	SELECT MAHV, DIEM 
	FROM KETQUATHI A
	WHERE NOT EXISTS (
		SELECT 1 
		FROM KETQUATHI B 
		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
	) AND MAMH = 'CSDL'
) DIEM_CSDL
ON HV.MAHV = DIEM_CSDL.MAHV
--Cau 18 phan III
SELECT HV.MAHV, HO + ' ' + TEN AS HOTEN, DIEM 
FROM HOCVIEN HV INNER JOIN (
	SELECT MAHV, MAX(DIEM) AS DIEM FROM KETQUATHI 
	WHERE MAMH IN (
		SELECT MAMH FROM MONHOC 
		WHERE TENMH = 'Co So Du Lieu'
	) 
	GROUP BY MAHV, MAMH
) DIEM_CSDL_MAX
ON HV.MAHV = DIEM_CSDL_MAX.MAHV
--Cau 20 phan III
SELECT HOCHAM, COUNT(HOCHAM) SL FROM GIAOVIEN 
WHERE HOCHAM IN ('GS', 'PGS') 
GROUP BY HOCHAM
--Cau 21 phan III
SELECT MAKHOA, HOCVI, COUNT(HOCVI) SL FROM GIAOVIEN 
GROUP BY MAKHOA, HOCVI
ORDER BY MAKHOA
--Cau 22 phan III
SELECT MAMH, KETQUA, COUNT(MAHV) SL
FROM KETQUATHI KQA
WHERE NOT EXISTS (
	SELECT 1 
	FROM KETQUATHI KQB 
	WHERE KQA.MAHV = KQB.MAHV AND KQA.MAMH = KQB.MAMH AND KQA.LANTHI < KQB.LANTHI
)
GROUP BY MAMH, KETQUA
--Cau 23 phan III
SELECT MAGV, HOTEN 
FROM GIAOVIEN 
WHERE MAGV IN(
	SELECT DISTINCT MAGV
	FROM GIANGDAY GD INNER JOIN LOP
	ON GD.MALOP = LOP.MALOP
	WHERE MAGV = MAGVCN 
)
--Cau 24 phan III
SELECT HO + ' ' + TEN HOTEN FROM LOP INNER JOIN HOCVIEN HV
ON LOP.TRGLOP = HV.MAHV
WHERE SISO = (
	SELECT MAX(SISO) FROM LOP
)
--Cau 26 phan III
SELECT A.MAHV, HO + ' ' + TEN HOTEN FROM (
	SELECT MAHV, RANK () OVER (ORDER BY COUNT(MAMH) DESC) HANG_MH FROM KETQUATHI KQ 
	WHERE DIEM BETWEEN 9 AND 10
	GROUP BY KQ.MAHV
) A INNER JOIN HOCVIEN HV
ON A.MAHV = HV.MAHV
WHERE HANG_MH = 1
--Cau 27 phan III
SELECT LEFT(A.MAHV, 3) MALOP, A.MAHV, HO + ' ' + TEN HOTEN FROM (
	SELECT MAHV, RANK () OVER (ORDER BY COUNT(MAMH) DESC) HANG_MH FROM KETQUATHI KQ 
	WHERE DIEM BETWEEN 9 AND 10
	GROUP BY KQ.MAHV
) A INNER JOIN HOCVIEN HV
ON A.MAHV = HV.MAHV
WHERE HANG_MH = 1
GROUP BY LEFT(A.MAHV, 3), A.MAHV, HO, TEN
--Cau 28 phan III
SELECT HOCKY, NAM, MAGV, COUNT(MAMH) SOMH, COUNT(MALOP) SOLOP FROM GIANGDAY
GROUP BY HOCKY, NAM, MAGV
--Cau 30 phan III
SELECT A.MAMH, TENMH FROM (
	SELECT MAMH, RANK() OVER (ORDER BY COUNT(MAHV) DESC) HANG_SOHV FROM KETQUATHI
	WHERE LANTHI = 1 AND KETQUA = 'Khong Dat'
	GROUP BY MAMH
) A INNER JOIN MONHOC MH
ON A.MAMH = MH.MAMH
WHERE HANG_SOHV = 1
--Cau 31 phan III
SELECT A.MAHV, HO + ' ' + TEN HOTEN FROM (
	SELECT MAHV, COUNT(KETQUA) SODAT FROM KETQUATHI 
	WHERE LANTHI = 1 AND KETQUA = 'Dat'
	GROUP BY MAHV
	INTERSECT
	SELECT MAHV, COUNT(MAMH) SOMH FROM KETQUATHI 
	WHERE LANTHI = 1
	GROUP BY MAHV
) A INNER JOIN HOCVIEN HV
ON A.MAHV = HV.MAHV
--Cau 32 phan III
SELECT C.MAHV, HO + ' ' + TEN HOTEN FROM (
	SELECT MAHV, COUNT(KETQUA) SODAT FROM KETQUATHI A
	WHERE NOT EXISTS (
		SELECT 1 
		FROM KETQUATHI B 
		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
	) AND KETQUA = 'Dat'
	GROUP BY MAHV
	INTERSECT
	SELECT MAHV, COUNT(MAMH) SOMH FROM KETQUATHI 
	WHERE LANTHI = 1
	GROUP BY MAHV
) C INNER JOIN HOCVIEN HV
ON C.MAHV = HV.MAHV
--Cau 33 phan III
SELECT A.MAHV, HO + ' ' + TEN HOTEN FROM (
	SELECT MAHV, COUNT(KETQUA) SODAT FROM KETQUATHI 
	WHERE LANTHI = 1 AND KETQUA = 'Dat'
	GROUP BY MAHV
	INTERSECT
	SELECT MAHV, COUNT(MAMH) SOMH FROM KETQUATHI 
	WHERE LANTHI = 1
	GROUP BY MAHV
) A INNER JOIN HOCVIEN HV
ON A.MAHV = HV.MAHV
--Cau 34 phan III
SELECT C.MAHV, HO + ' ' + TEN HOTEN FROM (
	SELECT MAHV, COUNT(KETQUA) SODAT FROM KETQUATHI A
	WHERE NOT EXISTS (
		SELECT 1 FROM KETQUATHI B 
		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
	) AND KETQUA = 'Dat'
	GROUP BY MAHV
	INTERSECT
	SELECT MAHV, COUNT(MAMH) SOMH FROM KETQUATHI 
	WHERE LANTHI = 1
	GROUP BY MAHV
) C INNER JOIN HOCVIEN HV
ON C.MAHV = HV.MAHV
SELECT	B.MALOP,A.MAHV, HO, TEN,COUNT(MAMH) [SO MON] 
FROM		KETQUATHI A, HOCVIEN B
WHERE	A.MAHV=B.MAHV AND (DIEM=9 OR DIEM=10) 
GROUP BY  B.MALOP, A.MAHV, HO, TEN
HAVING	COUNT(MAMH)>=ALL(SELECT 	COUNT(MAMH)
					  FROM	KETQUATHI C, HOCVIEN D
					  WHERE	C.MAHV=D.MAHV AND B.MALOP=D.MALOP AND (DIEM BETWEEN 9 AND 10)
					  GROUP BY C.MAHV)

--CAU 10 TRIGGER
GO
CREATE TRIGGER TRG_TRUONGKHOA_HOCVI
ON KHOA
AFTER INSERT, UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED
			JOIN GIAOVIEN ON INSERTED.TRGKHOA = GIAOVIEN.MAGV
			WHERE (GIAOVIEN.HOCVI != 'TS' AND GIAOVIEN.HOCHAM != 'PGS') OR
				INSERTED.TRGKHOA NOT IN (
					SELECT GIAOVIEN.MAGV FROM GIAOVIEN AS GV2 WHERE GV2.MAKHOA = INSERTED.MAKHOA
				)
		)
	)
	BEGIN
		PRINT 'ERROR: TRUONG KHOA PHAI NAM TRONG KHOA VA LA TS HOAC PGS'
		ROLLBACK TRANSACTION
	END
END
GO
CREATE TRIGGER TRG_TRUONGKHOA_GIAOVIEN
ON GIAOVIEN
AFTER UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED
			WHERE INSERTED.MAGV IN (
				SELECT KHOA.TRGKHOA
				FROM KHOA
				JOIN GIAOVIEN ON KHOA.TRGKHOA = GIAOVIEN.MAGV
				WHERE (GIAOVIEN.HOCHAM != 'PGS' AND GIAOVIEN.HOCVI != 'TS') OR KHOA.MAKHOA != INSERTED.MAKHOA
			)
		)
	)
	BEGIN
		PRINT 'ERROR: TRUONG KHOA PHAI NAM TRONG KHOA VA LA TS HOAC PGS'
		ROLLBACK TRANSACTION
	END
END
--CAU 15 TRIGGER
go
create trigger TRG_NGAYTHI_KQTHI 
on KETQUATHI
after insert, update
as begin
	if (
		exists (
			select * 
			from INSERTED 
			JOIN HOCVIEN ON INSERTED.MAHV = HOCVIEN.MAHV
			where NGTHI < (
					select DENNGAY 
					from GIANGDAY 
					where GIANGDAY.MAMH = INSERTED.MAMH and GIANGDAY.MALOP = HOCVIEN.MALOP
				)
		)
	)
	begin
		print 'ERROR: NGAY THI KHONG HOP LE'
		rollback transaction
	end	
end
go
create trigger TRG_NGAYTHI_GIANGDAY
ON GIANGDAY
after update
as 
begin
	if (
		exists (
			select * 
			from INSERTED
				where exists (
					select * from KETQUATHI
					where MAMH = INSERTED.MAMH 
						AND INSERTED.MALOP = (SELECT MALOP FROM HOCVIEN WHERE HOCVIEN.MAHV = KETQUATHI.MAHV)
						AND NGTHI < INSERTED.DENNGAY
				)
		)
	)
	begin
		print 'NGAY THI KHONG HOP LE'
		rollback transaction
	end
end
go
create trigger TRG_NGAYTHI_HOCVIEN
on HOCVIEN
after update
as 
begin
	if (
		exists(
			select * from INSERTED
			where exists (
				select * from KETQUATHI
				where KETQUATHI.MAHV = INSERTED.MAHV 
					and KETQUATHI.NGTHI < (
							select DENNGAY from GIANGDAY
							where GIANGDAY.MALOP = INSERTED.MALOP 
								and GIANGDAY.MAMH = KETQUATHI.MAMH)
					)
			)
	)
	begin
		print 'ERROR: LOP CHUA HOAN THANH MON HOC'
		rollback transaction
	end
end
--CAU 16 TRIGGER
GO
CREATE TRIGGER TRG_MONHOCTOIDA
ON GIANGDAY
AFTER INSERT, UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * 
			FROM INSERTED
			WHERE MALOP IN (
				SELECT MALOP
				FROM GIANGDAY
				WHERE GIANGDAY.MALOP = INSERTED.MALOP
				GROUP BY MALOP, NAM
				HAVING COUNT(*) > 3
			)
		)
	)
	BEGIN
		PRINT 'ERROR: MOT NAM CHI CO TOI DA 3 LOP'
		ROLLBACK TRANSACTION
	END
END
--CAU 17 TRIGGER
GO
CREATE TRIGGER TRG_SISI_LOP_INSERT
ON LOP
AFTER INSERT
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED
			WHERE SISO > 0
		)
	)
	BEGIN
		PRINT 'LOP VUA THEM PHAI CO 0 SINH VIEN'
		ROLLBACK TRANSACTION
	END
END
GO
CREATE TRIGGER TRG_SISO_LOP_UPDATE
ON LOP
AFTER UPDATE
AS
BEGIN
	IF (UPDATE(SISO))
	BEGIN
		PRINT 'KHONG DUOC UPDATE SISO'
		ROLLBACK TRANSACTION
	END
END
GO
CREATE TRIGGER TRG_SISO_HOCVIEN
ON HOCVIEN
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
	UPDATE LOP
	SET SISO = SISO + TEMP.SLHOCVIEN
	FROM LOP 
	JOIN (
		SELECT LOP.MALOP, COUNT(*) AS SLHOCVIEN
		FROM INSERTED 
		JOIN LOP ON LOP.MALOP = INSERTED.MALOP
		GROUP BY LOP.MALOP
	) AS TEMP ON TEMP.MALOP = LOP.MALOP

	UPDATE LOP
	SET SISO = SISO + TEMP.SLHOCVIEN
	FROM LOP 
	JOIN (
		SELECT LOP.MALOP, COUNT(*) AS SLHOCVIEN
		FROM INSERTED 
		JOIN LOP ON LOP.MALOP = INSERTED.MALOP
		GROUP BY LOP.MALOP
	) AS TEMP ON TEMP.MALOP = LOP.MALOP
END
--CAU 19 TRIGGER
GO
CREATE TRIGGER TRG_HOCVIHOCHAM_MUCLUONG
ON GIAOVIEN
AFTER INSERT, UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED
			WHERE EXISTS (
				SELECT * FROM GIAOVIEN
				WHERE GIAOVIEN.MAGV != INSERTED.MAGV
					AND GIAOVIEN.HOCHAM = INSERTED.HOCHAM
					AND GIAOVIEN.HOCVI = INSERTED.HOCVI
					AND GIAOVIEN.HESO = INSERTED.HESO
					AND GIAOVIEN.MUCLUONG != INSERTED.MUCLUONG
			)
		)
	)
	BEGIN
		PRINT 'ERROR: CO 2 GV CO CUNG HOCHAM, HOCVI, HESO NHUNG MUCLUONG KHAC NHAU'
		ROLLBACK TRANSACTION
	END
END
--CAU 20 TRIGGER
GO
CREATE TRIGGER TRG_THILAI_KQTHI
ON KETQUATHI
AFTER INSERT, UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED
			WHERE INSERTED.LANTHI > 1 AND EXISTS (
				SELECT * FROM KETQUATHI
				WHERE KETQUATHI.MAHV = INSERTED.MAHV
					AND KETQUATHI.MAMH = INSERTED.MAMH
					AND KETQUATHI.LANTHI = INSERTED.LANTHI - 1
					AND KETQUATHI.DIEM >= 5
			)
		)
	)
	BEGIN
		PRINT 'LAN THI TRUOC PHAI CO DIEM < 5'
		ROLLBACK TRAN
	END
END
--CAU 21 TRIGGER
GO
CREATE TRIGGER TRG_NGAYTHI
ON KETQUATHI
AFTER INSERT, UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED 
			WHERE EXISTS (
				SELECT * FROM KETQUATHI
				WHERE
					KETQUATHI.MAHV = INSERTED.MAHV AND
					KETQUATHI.MAMH = INSERTED.MAMH AND
					((KETQUATHI.LANTHI < INSERTED.LANTHI AND
					KETQUATHI.NGTHI > INSERTED.NGTHI) OR
					(KETQUATHI.LANTHI > INSERTED.LANTHI AND
					KETQUATHI.NGTHI < INSERTED.NGTHI))
			)
		)
	)
	BEGIN
		PRINT 'LAN THI SAU PHAI THI SAU LAN THI TRUOC'
		ROLLBACK TRANSACTION
	END
END
--CAU 24 TRIGGER
GO
CREATE TRIGGER TRG_MONHOCKHOA_GIANGDAY
ON GIANGDAY
AFTER INSERT, UPDATE
AS
BEGIN
	IF exists(
		SELECT * FROM INSERTED 
		WHERE (SELECT MAKHOA FROM GIAOVIEN WHERE GIAOVIEN.MAGV = INSERTED.MAGV) !=
				(SELECT MAKHOA FROM MONHOC WHERE MONHOC.MAMH = INSERTED.MAMH)
	)
	BEGIN
		PRINT 'ERROR: MON HOC KHONG THUOC KHOA GV PHU TRACH'
		ROLLBACK TRANSACTION
	END
END
GO
CREATE TRIGGER TRG_MONHOCKHOA_GIAOVIEN
ON GIAOVIEN
AFTER UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED
			WHERE EXISTS (
				SELECT * FROM GIANGDAY
				WHERE GIANGDAY.MAGV = INSERTED.MAGV 
					AND (SELECT MAKHOA FROM MONHOC WHERE MONHOC.MAMH = GIANGDAY.MAMH) != INSERTED.MAKHOA
			)
		)
	)
	BEGIN
		PRINT 'ERROR: MON HOC KHONG THUOC KHOA GV PHU TRACH'
		ROLLBACK TRANSACTION
	END
END
GO
CREATE TRIGGER TRG_MONHOCKHOA_MONHOC
ON MONHOC
AFTER INSERT, UPDATE
AS
BEGIN
	IF (
		EXISTS (
			SELECT * FROM INSERTED
			WHERE EXISTS (
				SELECT * FROM GIANGDAY
				WHERE GIANGDAY.MAMH = INSERTED.MAMH AND
					(SELECT MAKHOA FROM GIAOVIEN WHERE GIANGDAY.MAGV = GIAOVIEN.MAGV) != INSERTED.MAKHOA
			)
		)
	)
	BEGIN
		PRINT 'ERROR: MON HOC KHONG THUOC KHOA GV PHU TRACH'
		ROLLBACK TRANSACTION
	END
END